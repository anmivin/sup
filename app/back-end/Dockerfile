FROM node:18

ARG API_HOST
ARG PORT
ARG ROUTES_PREFIX

ARG DB_USERNAME
ARG DB_PASSWORD
ARG DB_DATABASE
ARG DB_HOST
ARG DB_PORT
ARG DB_DIALECT

ARG SALT
ARG JWT_SECRET
ARG JWT_EXPIRED

ARG GOOGLE_CLIENT_ID
ARG GOOGLE_SECRET
ARG GOOGLE_CALLBACK_URL

ARG MINIO_ENDPOINT
ARG MINIO_PORT
ARG MINIO_ACCESS
ARG MINIO_SECRET
ARG MINIO_URL

ENV API_HOST=${API_HOST}
ENV PORT=${PORT}
ENV ROUTES_PREFIX=${ROUTES_PREFIX}

ENV DB_USERNAME=${DB_USERNAME}
ENV DB_PASSWORD=${DB_PASSWORD}
ENV DB_DATABASE=${DB_DATABASE}
ENV DB_HOST=${DB_HOST}
ENV DB_PORT=${DB_PORT}
ENV DB_DIALECT=${DB_DIALECT}

ENV SALT = ${SALT}
ENV JWT_SECRET = ${JWT_SECRET}
ENV JWT_EXPIRED = ${JWT_EXPIRED}

ENV GOOGLE_CLIENT_ID = ${GOOGLE_CLIENT_ID}
ENV GOOGLE_SECRET = ${GOOGLE_SECRET}
ENV GOOGLE_CALLBACK_URL = ${GOOGLE_CALLBACK_URL}

ENV MINIO_ENDPOINT=${MINIO_ENDPOINT}
ENV MINIO_PORT=${MINIO_PORT}
ENV MINIO_ACCESS=${MINIO_ACCESS}
ENV MINIO_SECRET=${MINIO_SECRET}
ENV MINIO_URL=${MINIO_URL}

WORKDIR /server

COPY package*.json ./
COPY ../../backend-shared ./backend-shared

RUN npm ci

COPY . ./app/back-end

RUN npm run migration:run

EXPOSE 3001

CMD ["npm", "run", "start"]